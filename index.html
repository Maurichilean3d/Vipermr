<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Víbora MR – Room Planes</title>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<style>
html,body{margin:0;padding:0;overflow:hidden;background:transparent}
canvas{background:transparent}
#ui{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
#btn{pointer-events:auto;padding:16px 32px;font-size:18px;font-weight:900;border:none;border-radius:30px;background:#ffaa00}
#hud{position:absolute;top:16px;left:16px;color:#ffaa00;font-weight:900;display:none;white-space:pre}
#damage{position:fixed;inset:0;background:red;opacity:0;pointer-events:none;transition:.15s}
</style>
</head>
<body>

<div id="damage"></div>
<div id="ui">
  <button id="btn">INICIAR MR</button>
  <div id="hud">ESQUIVADAS: 0</div>
</div>

<script type="importmap">
{ "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js" } }
</script>

<script type="module">
import * as THREE from 'three';

let scene,camera,renderer,xrSession,xrRefSpace;
const clock=new THREE.Clock();
const btn=document.getElementById('btn');
const hud=document.getElementById('hud');
const dmg=document.getElementById('damage');

const snakes=[];
const roomPlanes=new Map();
let score=0,gameOver=false;

const MAT_WALL=new THREE.MeshBasicMaterial({color:0x00ffff,transparent:true,opacity:.12,side:THREE.DoubleSide,depthWrite:false});
const MAT_FLOOR=new THREE.MeshBasicMaterial({color:0x00ff00,transparent:true,opacity:.10,side:THREE.DoubleSide,depthWrite:false});
const MAT_CEIL=new THREE.MeshBasicMaterial({color:0xff00ff,transparent:true,opacity:.10,side:THREE.DoubleSide,depthWrite:false});

init();

function init(){
  scene=new THREE.Scene();
  camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,.01,30);
  scene.add(new THREE.HemisphereLight(0xffffff,0x444444,1.3));

  renderer=new THREE.WebGLRenderer({alpha:true,antialias:true});
  renderer.xr.enabled=true;
  renderer.setClearColor(0x000000,0);
  renderer.setSize(innerWidth,innerHeight);
  document.body.appendChild(renderer.domElement);

  btn.onclick=startMR;
  addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight)});
  renderer.setAnimationLoop(render);
}

async function startMR(){
  xrSession=await navigator.xr.requestSession('immersive-ar',{
    requiredFeatures:['local-floor'],
    optionalFeatures:['plane-detection','dom-overlay'],
    domOverlay:{root:document.body}
  });
  renderer.xr.setSession(xrSession);
  xrRefSpace=await xrSession.requestReferenceSpace('local-floor');
  btn.style.display='none';
  hud.style.display='block';
  score=0;gameOver=false;
}

function updateRoomPlanes(frame){
  if(!xrSession?.detectedPlanes)return;
  for(const [p,e] of roomPlanes){ if(!xrSession.detectedPlanes.has(p)){scene.remove(e.mesh);roomPlanes.delete(p);} }
  for(const p of xrSession.detectedPlanes){
    let e=roomPlanes.get(p);
    if(!e){
      e={mesh:new THREE.Mesh(new THREE.PlaneGeometry(1,1),MAT_WALL),right:new THREE.Vector3(),up:new THREE.Vector3(),normal:new THREE.Vector3()};
      scene.add(e.mesh);roomPlanes.set(p,e);
    }
    const pose=frame.getPose(p.planeSpace,xrRefSpace); if(!pose)continue;
    const m=new THREE.Matrix4().fromArray(pose.transform.matrix);
    e.mesh.position.setFromMatrixPosition(m);
    e.mesh.quaternion.setFromRotationMatrix(m);
    e.right.set(1,0,0).applyQuaternion(e.mesh.quaternion);
    e.up.set(0,1,0).applyQuaternion(e.mesh.quaternion);
    e.normal.set(0,0,1).applyQuaternion(e.mesh.quaternion);
    const dot=Math.abs(e.up.dot(new THREE.Vector3(0,1,0)));
    e.mesh.material = dot>.85 ? (e.mesh.position.y>1.8?MAT_CEIL:MAT_FLOOR) : MAT_WALL;
    e.mesh.geometry.dispose();
    e.mesh.geometry=new THREE.PlaneGeometry(4, dot>.85?4:2.6);
  }
}

function createSnake(){
  const g=new THREE.Group();
  const segs=[];
  for(let i=0;i<18;i++){
    const r=THREE.MathUtils.lerp(.04,.015,i/17);
    const geo=new THREE.CylinderGeometry(r*.8,r,.09,10);
    geo.rotateX(Math.PI/2);
    const m=new THREE.MeshStandardMaterial({color:0xff3333,roughness:.4});
    const s=new THREE.Mesh(geo,m);
    s.position.z=-i*.09;
    g.add(s);segs.push(s);
  }
  const head=new THREE.Mesh(new THREE.ConeGeometry(.06,.12,12).rotateX(Math.PI/2),new THREE.MeshStandardMaterial({color:0x111111}));
  g.add(head);
  scene.add(g);
  return {g,segs,trail:[],t:0};
}

function spawnSnake(){
  const walls=[...roomPlanes.values()].filter(e=>e.mesh.material===MAT_WALL);
  if(!walls.length)return;
  const w=walls[Math.random()*walls.length|0];
  const u=(Math.random()*2-1)*1.8;
  const v=Math.random()*2.2;
  const pos=w.mesh.position.clone().add(w.right.clone().multiplyScalar(u)).add(w.up.clone().multiplyScalar(v));
  const s=createSnake();
  s.wall=w;
  s.pos=pos.clone().add(w.normal.clone().multiplyScalar(-.3));
  s.g.position.copy(s.pos);
  snakes.push(s);
}

function updateSnakes(dt){
  const player=new THREE.Vector3();camera.getWorldPosition(player);
  for(let i=snakes.length-1;i>=0;i--){
    const s=snakes[i];s.t+=dt;
    if(s.t<.6)s.pos.addScaledVector(s.wall.normal,dt*.6);
    else{
      const u=Math.sin(s.t*.5)*1.6;
      const v=.5+Math.sin(s.t*.3)*1.1;
      s.pos=s.wall.mesh.position.clone().add(s.wall.right.clone().multiplyScalar(u)).add(s.wall.up.clone().multiplyScalar(v));
    }
    s.trail.unshift(s.pos.clone());
    if(s.trail.length>80)s.trail.pop();
    s.g.position.copy(s.pos);
    for(let j=0;j<s.segs.length;j++){
      const p=s.trail[Math.min(j*4,s.trail.length-1)];
      if(!p)continue;
      const local=s.g.worldToLocal(p.clone());
      local.x+=Math.sin(s.t*6-j*.5)*.04;
      s.segs[j].position.copy(local);
    }
    if(s.pos.distanceTo(player)<.35&&!gameOver){
      gameOver=true;
      dmg.style.opacity=.7;
      setTimeout(()=>dmg.style.opacity=0,200);
    }
    if(s.t>8){scene.remove(s.g);snakes.splice(i,1);score++;hud.textContent=`ESQUIVADAS: ${score}`;}
  }
}

function render(t,frame){
  const dt=Math.min(.05,clock.getDelta());
  if(frame){
    updateRoomPlanes(frame);
    if(Math.random()<.01)spawnSnake();
    updateSnakes(dt);
  }
  renderer.render(scene,camera);
}
</script>
</body>
</html>

