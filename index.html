<!DOCTYPE html>
<html>
  <head>
    <title>Snake Attack VR - Quest 3</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>
  </head>
  <body>
    <script>
      // COMPONENTE: Lógica del Juego
      AFRAME.registerComponent('game-manager', {
        schema: {
          level: {type: 'int', default: 1},
          spawnRate: {type: 'number', default: 3000} // ms entre víboras
        },
        init: function() {
          this.timer = 0;
          this.isPlaying = true;
          this.player = document.querySelector('#player');
          this.score = 0;
          this.scoreText = document.querySelector('#score-text');
          
          // Sonidos (simulados visualmente por ahora)
          console.log("Juego iniciado. Nivel: " + this.data.level);
        },
        tick: function(time, timeDelta) {
          if (!this.isPlaying) return;

          this.timer += timeDelta;
          
          // Dificultad dinámica
          let currentRate = Math.max(800, 3000 - (this.score * 100)); // Se vuelve más rápido

          if (this.timer > currentRate) {
            this.spawnEvent();
            this.timer = 0;
          }

          // Verificar colisiones
          this.checkCollisions();
        },
        spawnEvent: function() {
          // 1. Elegir pared/techo/suelo al azar
          const walls = [
            {pos: {x: -5, y: 2, z: 0}, rot: {x: 0, y: 90, z: 0}, normal: {x: 1, y: 0, z: 0}}, // Izquierda
            {pos: {x: 5, y: 2, z: 0}, rot: {x: 0, y: -90, z: 0}, normal: {x: -1, y: 0, z: 0}}, // Derecha
            {pos: {x: 0, y: 2, z: -5}, rot: {x: 0, y: 0, z: 0}, normal: {x: 0, y: 0, z: 1}}, // Frente
            {pos: {x: 0, y: 2, z: 5}, rot: {x: 0, y: 180, z: 0}, normal: {x: 0, y: 0, z: -1}}, // Atrás
            {pos: {x: 0, y: 5, z: 0}, rot: {x: 90, y: 0, z: 0}, normal: {x: 0, y: -1, z: 0}}, // Techo
            {pos: {x: 0, y: 0.1, z: 0}, rot: {x: -90, y: 0, z: 0}, normal: {x: 0, y: 1, z: 0}} // Suelo
          ];

          const wall = walls[Math.floor(Math.random() * walls.length)];
          
          // Aleatoriedad en la posición de la pared
          const offsetA = (Math.random() - 0.5) * 6;
          const offsetB = (Math.random() - 0.5) * 6;
          
          let spawnPos = { ...wall.pos };
          if (wall.normal.y !== 0) { // Suelo o Techo
             spawnPos.x += offsetA; 
             spawnPos.z += offsetB;
          } else { // Paredes laterales
             if(wall.normal.x !== 0) spawnPos.z += offsetA;
             else spawnPos.x += offsetA;
             spawnPos.y = Math.max(0.5, spawnPos.y + offsetB); // Evitar que salga muy abajo
          }

          // 2. Crear grieta de advertencia
          this.createCrack(spawnPos, wall.rot, wall.normal);
        },

        createCrack: function(pos, rot, normal) {
          const scene = this.el.sceneEl;
          const crack = document.createElement('a-entity');
          
          crack.setAttribute('position', pos);
          crack.setAttribute('rotation', rot);
          
          // Visual de la grieta
          crack.setAttribute('geometry', 'primitive: plane; height: 1; width: 1');
          crack.setAttribute('material', 'src: #crackTex; transparent: true; opacity: 0.8');
          crack.setAttribute('scale', '0.1 0.1 0.1');
          
          // Animación de vibración y crecimiento
          crack.setAttribute('animation', 'property: scale; to: 1 1 1; dur: 1500; easing: easeInElastic');
          
          scene.appendChild(crack);

          // 3. Después de 1.5s, sale la víbora y escombros
          setTimeout(() => {
            this.spawnDebris(pos, normal);
            this.spawnSnake(pos, normal);
            crack.parentNode.removeChild(crack); // Quitar grieta
          }, 1500);
        },

        spawnDebris: function(pos, normal) {
            const scene = this.el.sceneEl;
            // Generar 10 pedazos de escombros
            for(let i=0; i<10; i++) {
                let debris = document.createElement('a-box');
                debris.setAttribute('position', pos);
                debris.setAttribute('scale', '0.1 0.1 0.1');
                debris.setAttribute('color', '#555');
                // Física simple: mover en dirección normal + aleatorio
                let velocity = {
                    x: (normal.x * 0.1) + (Math.random()-0.5)*0.05,
                    y: (normal.y * 0.1) + (Math.random()-0.5)*0.05,
                    z: (normal.z * 0.1) + (Math.random()-0.5)*0.05
                };
                debris.setAttribute('debris-move', {velocity: velocity});
                scene.appendChild(debris);
            }
        },

        spawnSnake: function(pos, normal) {
            const scene = this.el.sceneEl;
            const snake = document.createElement('a-entity');
            
            // Determinar Tipo de Víbora (Nivel)
            let isBoa = this.score > 5; // Después de esquivar 5, salen Boas
            let scale = isBoa ? '0.3 0.3 0.3' : '0.1 0.1 0.1';
            let color = isBoa ? '#4A3728' : '#FF0000'; // Boa Café vs Coralillo Roja
            let length = isBoa ? 5 : 2;
            let speed = isBoa ? 4000 : 2000; // La boa es más lenta pero grande

            snake.setAttribute('position', pos);
            
            // Modelo simple de víbora (cabeza + cuerpo)
            // Cabeza
            const head = document.createElement('a-sphere');
            head.setAttribute('color', isBoa ? 'green' : 'black');
            head.setAttribute('radius', '0.2');
            head.setAttribute('position', '0 0 0');
            snake.appendChild(head);
            
            // Cuerpo (cilindro largo)
            const body = document.createElement('a-cylinder');
            body.setAttribute('color', color);
            body.setAttribute('height', length);
            body.setAttribute('radius', 0.15);
            body.setAttribute('rotation', '90 0 0');
            body.setAttribute('position', `0 0 -${length/2}`);
            snake.appendChild(body);

            snake.setAttribute('look-at', '#player'); // Mirar siempre al jugador
            snake.classList.add('enemy');
            
            // Animación de ataque (salir y cruzar la sala)
            // Calculamos un punto destino cruzando la sala
            let target = {
                x: pos.x + (normal.x * 10),
                y: pos.y + (normal.y * 10),
                z: pos.z + (normal.z * 10)
            };

            snake.setAttribute('animation', `property: position; to: ${target.x} ${target.y} ${target.z}; dur: ${speed}; easing: linear`);
            
            // Eliminar después del ataque
            setTimeout(() => {
                if(snake.parentNode) {
                    snake.parentNode.removeChild(snake);
                    this.score++;
                    this.scoreText.setAttribute('value', 'Esquivadas: ' + this.score);
                }
            }, speed);

            scene.appendChild(snake);
        },

        checkCollisions: function() {
            let playerPos = this.player.getAttribute('position');
            let enemies = document.querySelectorAll('.enemy');
            
            enemies.forEach(enemy => {
                let enemyPos = enemy.getAttribute('position');
                let dist = Math.sqrt(
                    Math.pow(enemyPos.x - playerPos.x, 2) +
                    Math.pow(enemyPos.y - playerPos.y, 2) +
                    Math.pow(enemyPos.z - playerPos.z, 2)
                );

                if (dist < 0.6) { // Radio de colisión
                    this.gameOver();
                }
            });
        },

        gameOver: function() {
            this.isPlaying = false;
            let feedback = document.querySelector('#damage-indicator');
            feedback.setAttribute('visible', true);
            this.scoreText.setAttribute('value', 'GAME OVER - Reiniciando...');
            setTimeout(() => {
                location.reload();
            }, 2000);
        }
      });

      // COMPONENTE: Movimiento de Escombros
      AFRAME.registerComponent('debris-move', {
        schema: {
            velocity: {type: 'vec3'}
        },
        tick: function() {
            let el = this.el;
            let pos = el.getAttribute('position');
            el.setAttribute('position', {
                x: pos.x + this.data.velocity.x,
                y: pos.y + this.data.velocity.y,
                z: pos.z + this.data.velocity.z
            });
            // Rotación aleatoria
            el.object3D.rotation.x += 0.1;
            
            // Desaparecer si se aleja mucho
            if(Math.abs(pos.x) > 10 || Math.abs(pos.y) > 10 || Math.abs(pos.z) > 10) {
                if(el.parentNode) el.parentNode.removeChild(el);
            }
        }
      });
    </script>

    <a-scene game-manager background="color: #111">
      <a-assets>
        <img id="crackTex" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAMAAACdt4HsAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAAZQTFRFAAAAAAAApWe5zwAAAAJ0Uk5T/wDltzBKAAAAPklEQVR42uzYQQ0AAAgDseHfNC4IyVoD912WAACg8XR/4Wl/4Wl/4Wl/4Wl/4Wl/4Wl/4Wl/4Wl/4Wn/AAAA//8DAF9mA1H11OAhAAAAAElFTkSuQmCC">
      </a-assets>

      <a-box position="0 2.5 -5" width="10" height="5" depth="0.1" color="#333"></a-box> <a-box position="0 2.5 5" width="10" height="5" depth="0.1" color="#333"></a-box>  <a-box position="-5 2.5 0" width="0.1" height="5" depth="10" color="#444"></a-box> <a-box position="5 2.5 0" width="0.1" height="5" depth="10" color="#444"></a-box>  <a-plane position="0 0 0" rotation="-90 0 0" width="10" height="10" color="#222"></a-plane> <a-plane position="0 5 0" rotation="90 0 0" width="10" height="10" color="#222"></a-plane>  <a-entity id="player" position="0 1.6 0">
        <a-camera look-controls wasd-controls>
            <a-plane id="damage-indicator" position="0 0 -0.1" width="2" height="2" color="red" material="transparent: true; opacity: 0.5" visible="false"></a-plane>
            <a-text id="score-text" value="Esquivadas: 0" position="-0.5 0.5 -1" color="white"></a-text>
        </a-camera>
      </a-entity>

    </a-scene>
  </body>
</html>
