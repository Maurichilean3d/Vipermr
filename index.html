<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>MR Snake Demo – FIX START</title>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<style>
html,body{margin:0;padding:0;overflow:hidden;background:#000}
#start{
  position:fixed;
  inset:0;
  margin:auto;
  width:260px;
  height:70px;
  font-size:20px;
  font-weight:900;
  border:none;
  border-radius:40px;
  background:#ffaa00;
  z-index:10;
}
#info{
  position:fixed;
  top:20px;
  left:20px;
  color:#00eaff;
  font-weight:900;
  z-index:10;
}
canvas{position:fixed;inset:0}
</style>
</head>
<body>

<button id="start">INICIAR MR</button>
<div id="info">ESPERANDO</div>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js"
  }
}
</script>

<script type="module">
import * as THREE from "three";

/* =======================
   VARIABLES CORE
======================= */
let scene, camera, renderer;
let xrSession = null;
let xrRefSpace = null;
let started = false;

const info = document.getElementById("info");
const startBtn = document.getElementById("start");

/* =======================
   INIT NORMAL (NO XR)
======================= */
scene = new THREE.Scene();
camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 30);
scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.3));

renderer = new THREE.WebGLRenderer({ alpha:true, antialias:true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.xr.enabled = true;
document.body.appendChild(renderer.domElement);

renderer.setAnimationLoop(() => {
  renderer.render(scene, camera);
});

/* =======================
   BOTÓN MR (FIX CLAVE)
======================= */
startBtn.addEventListener("click", async () => {

  if (!navigator.xr) {
    info.textContent = "WebXR NO disponible";
    return;
  }

  try {
    info.textContent = "SOLICITANDO SESIÓN XR...";
    xrSession = await navigator.xr.requestSession("immersive-ar", {
      requiredFeatures: ["local-floor"],
      optionalFeatures: ["dom-overlay"],
      domOverlay: { root: document.body }
    });

    xrSession.addEventListener("end", () => {
      info.textContent = "SESIÓN TERMINADA";
      startBtn.style.display = "block";
      started = false;
    });

    renderer.xr.setSession(xrSession);
    xrRefSpace = await xrSession.requestReferenceSpace("local-floor");

    startBtn.style.display = "none";
    started = true;
    info.textContent = "MR ACTIVO";

    spawnTestSnake();

  } catch (e) {
    info.textContent = "ERROR XR";
    console.error(e);
  }
});

/* =======================
   TEST VISUAL GARANTIZADO
======================= */
function spawnTestSnake() {
  const g = new THREE.Group();

  for (let i = 0; i < 16; i++) {
    const geo = new THREE.ConeGeometry(0.04, 0.08, 8);
    geo.rotateX(Math.PI / 2);
    const mat = new THREE.MeshStandardMaterial({ color: 0xff3333 });
    const m = new THREE.Mesh(geo, mat);
    m.position.z = -i * 0.08;
    g.add(m);
  }

  camera.getWorldPosition(g.position);
  g.position.add(new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion));

  scene.add(g);
}

/* =======================
   RESIZE
======================= */
window.addEventListener("resize", () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});
</script>

</body>
</html>

