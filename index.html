
<!DOCTYPE html>
<html>
  <head>
    <title>Snake Attack MR - Passthrough</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
  </head>
  <body>
    <script>
      // COMPONENTE: Gestor del Juego
      AFRAME.registerComponent('game-logic', {
        init: function() {
          this.score = 0;
          this.isGameOver = false;
          this.spawnTimer = 0;
          this.spawnInterval = 3000; // 3 segundos al inicio
          this.camera = document.querySelector('#camera');
          this.scoreText = document.querySelector('#scoreText');
          
          // Sonido simulado (log)
          console.log("Juego MR Iniciado");
        },
        tick: function(time, delta) {
          if (this.isGameOver) return;

          this.spawnTimer += delta;
          if (this.spawnTimer > this.spawnInterval) {
            this.spawnSnakeEvent();
            this.spawnTimer = 0;
            // Aumentar dificultad: más rápido cada vez
            if (this.spawnInterval > 800) this.spawnInterval -= 50;
          }

          this.checkCollisions();
        },
        spawnSnakeEvent: function() {
          // 1. Calcular posición en "Paredes" (Esfera de 3m alrededor del usuario)
          // Esto simula las paredes de tu habitación
          const angleX = Math.random() * Math.PI * 2;
          const angleY = (Math.random() - 0.5) * Math.PI; // Altura variable (Suelo/Techo)
          const radius = 3; // Distancia simulada a la pared

          const x = Math.cos(angleX) * Math.cos(angleY) * radius;
          const y = Math.sin(angleY) * radius;
          const z = Math.sin(angleX) * Math.cos(angleY) * radius;
          
          const spawnPos = {x: x, y: y, z: z};

          // 2. Crear la "Grieta" visual en esa posición
          this.createCrack(spawnPos);
        },

        createCrack: function(pos) {
            const scene = this.el.sceneEl;
            
            // Contenedor para el evento
            const pivot = document.createElement('a-entity');
            pivot.setAttribute('position', pos);
            pivot.setAttribute('look-at', '#camera'); // Que la grieta mire al usuario
            
            // Imagen de la grieta (Circular negra para simular agujero)
            const crack = document.createElement('a-circle');
            crack.setAttribute('color', '#111'); // Casi negro
            crack.setAttribute('radius', 0.01); // Empieza pequeña
            crack.setAttribute('material', 'shader: flat; opacity: 0.9');
            
            // Animación: La grieta se abre
            crack.setAttribute('animation', 'property: radius; to: 0.4; dur: 1000; easing: easeOutElastic');
            
            pivot.appendChild(crack);
            scene.appendChild(pivot);

            // 3. Salida de la víbora después de 1 segundo
            setTimeout(() => {
                this.explodeDebris(pivot);
                this.spawnSnake(pivot, pos);
            }, 1000);

            // Limpiar la grieta después de que pase todo
            setTimeout(() => {
                if(pivot.parentNode) pivot.parentNode.removeChild(pivot);
            }, 4000);
        },

        explodeDebris: function(parentEntity) {
            // Generar escombros que saltan hacia el jugador
            for(let i=0; i<8; i++) {
                let debris = document.createElement('a-box');
                debris.setAttribute('color', '#333');
                debris.setAttribute('scale', '0.05 0.05 0.05');
                debris.setAttribute('position', '0 0 0');
                
                // Fisica simple: Moverse hacia adelante (Z positivo local) y dispersarse
                let destX = (Math.random() - 0.5) * 2;
                let destY = (Math.random() - 0.5) * 2;
                
                debris.setAttribute('animation', `property: position; to: ${destX} ${destY} 2; dur: 800; easing: easeOutQuad`);
                debris.setAttribute('animation__rot', `property: rotation; to: ${Math.random()*360} ${Math.random()*360} 0; dur: 800`);
                
                parentEntity.appendChild(debris);
            }
        },

        spawnSnake: function(parentEntity, worldPos) {
            // Determinar tipo de víbora por puntuación
            let isBig = this.score > 5;
            let speed = isBig ? 1500 : 800; // Ms en llegar a ti
            let color = isBig ? '#5D4037' : '#D32F2F'; // Boa vs Coralillo
            let scale = isBig ? '0.2 0.2 0.2' : '0.08 0.08 0.08';
            
            const snake = document.createElement('a-entity');
            snake.setAttribute('position', '0 0 -1'); // Empieza "dentro" de la pared (atrás de la grieta)
            snake.classList.add('enemy');
            
            // Modelo visual
            const head = document.createElement('a-sphere');
            head.setAttribute('radius', 0.2);
            head.setAttribute('color', isBig ? 'green' : 'black');
            head.setAttribute('scale', scale);
            
            const body = document.createElement('a-cylinder');
            body.setAttribute('height', 2);
            body.setAttribute('radius', 0.1);
            body.setAttribute('color', color);
            body.setAttribute('rotation', '90 0 0');
            body.setAttribute('position', '0 0 -1'); // Cola hacia atrás
            body.setAttribute('scale', scale);

            snake.appendChild(head);
            snake.appendChild(body);
            parentEntity.appendChild(snake);

            // ANIMACIÓN DE ATAQUE: Salta hacia la cámara (Z local positivo)
            // Calculamos la distancia real a la cámara para que parezca que te golpea
            let dist = 3.5; // Un poco más del radio para asegurar impacto visual
            
            snake.setAttribute('animation', `property: position; to: 0 0 ${dist}; dur: ${speed}; easing: linear`);

            // Evento al terminar el ataque (si no te dio)
            setTimeout(() => {
                if (!this.isGameOver) {
                    this.score++;
                    this.scoreText.setAttribute('value', 'Esquivadas: ' + this.score);
                }
            }, speed);
        },

        checkCollisions: function() {
            // Detección simple: Si una víbora está muy cerca de la cámara (0,0,0 local)
            // Como las víboras son hijas de pivotes rotados, usamos World Position
            let playerPos = new THREE.Vector3();
            this.camera.object3D.getWorldPosition(playerPos);

            let enemies = document.querySelectorAll('.enemy');
            enemies.forEach(enemy => {
                let enemyPos = new THREE.Vector3();
                enemy.object3D.getWorldPosition(enemyPos);
                
                if (playerPos.distanceTo(enemyPos) < 0.4) {
                    this.gameOver();
                }
            });
        },

        gameOver: function() {
            if(this.isGameOver) return;
            this.isGameOver = true;
            
            // Feedback visual: Pantalla roja
            const feedback = document.querySelector('#damage');
            feedback.setAttribute('visible', true);
            this.scoreText.setAttribute('value', 'TE HAN MORDIDO! Reiniciando...');
            
            setTimeout(() => location.reload(), 2000);
        }
      });
    </script>

    <a-scene 
        webxr="optionalFeatures: hit-test, dom-overlay; overlay: true"
        renderer="alpha: true"
        background="color: transparent"
        game-logic>

      <a-entity id="camera" camera position="0 1.6 0" look-controls="magicWindowTrackingEnabled: false">
          <a-text id="scoreText" value="Espera el ataque..." position="0 0.2 -1" align="center" width="2" color="white" shader="msdf" font="roboto"></a-text>
          <a-plane id="damage" position="0 0 -0.1" width="2" height="2" color="red" material="transparent: true; opacity: 0.6" visible="false"></a-plane>
      </a-entity>

      <a-light type="directional" position="-1 2 1" intensity="1"></a-light>
      <a-light type="ambient" intensity="0.6"></a-light>

    </a-scene>
  </body>
</html>
