<!DOCTYPE html>
<html>
  <head>
    <title>Snake MR - Quest 3 Occlusion</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
  </head>
  <body>
    <script>
      // 1. COMPONENTE PARA GESTIONAR LA OCLUSIÓN (ROOM MESH)
      AFRAME.registerComponent('room-occlusion', {
        init: function () {
          this.el.sceneEl.addEventListener('enter-vr', () => {
            if (this.el.sceneEl.is('ar-mode')) {
              console.log("Modo AR activado - Buscando malla de habitación...");
              this.el.sceneEl.setAttribute('background', 'color: transparent');
            }
          });
        }
      });

      // 2. LOGICA DEL JUEGO Y SPAWN EN PAREDES REALES
      AFRAME.registerComponent('snake-spawner', {
        init: function() {
          this.timer = 0;
          this.spawnInterval = 3000;
          this.raycaster = new THREE.Raycaster();
          
          // Vector auxiliar
          this.tempVec = new THREE.Vector3();
        },

        tick: function(time, delta) {
          this.timer += delta;
          if(this.timer > this.spawnInterval) {
            this.spawnSnake();
            this.timer = 0;
            // Aumentar dificultad reduciendo tiempo
            if(this.spawnInterval > 800) this.spawnInterval -= 50; 
          }
        },

        spawnSnake: function() {
            // Intentar encontrar una pared real usando Raycasting desde el centro hacia afuera
            // Disparamos rayos aleatorios desde el jugador para encontrar el Room Mesh
            const playerPos = document.querySelector('#camera').object3D.position;
            
            // Dirección aleatoria
            const dir = new THREE.Vector3(
                Math.random() - 0.5,
                (Math.random() - 0.5) * 0.5, // Menos verticalidad extrema
                Math.random() - 0.5
            ).normalize();

            this.raycaster.set(playerPos, dir);
            
            // Buscamos intersección con el entorno (Room Mesh)
            // Nota: En WebXR puro, acceder a la malla directamente es complejo.
            // TRUCO: Como fallback si no detectamos malla exacta, usaremos una esfera virtual de 3 metros
            // pero si la malla está presente, la oclusión funcionará igual.
            
            const distance = 2.5 + Math.random() * 1.5; // Entre 2.5 y 4 metros
            const spawnPos = new THREE.Vector3().copy(playerPos).add(dir.multiplyScalar(distance));
            
            // Calculamos la rotación para que mire al jugador
            const lookAtPos = new THREE.Vector3().copy(playerPos);
            
            // Crear el evento
            this.createSnakeEvent(spawnPos, lookAtPos);
        },

        createSnakeEvent: function(pos, lookAtTarget) {
            const scene = this.el.sceneEl;

            // 1. Grieta / Escombros (Visual)
            const crack = document.createElement('a-entity');
            crack.setAttribute('position', pos);
            crack.setAttribute('look-at', '#camera');
            
            // Particulas de explosión (Simuladas con a-box)
            for(let i=0; i<8; i++) {
                let debris = document.createElement('a-box');
                debris.setAttribute('color', '#444');
                debris.setAttribute('scale', '0.05 0.05 0.05');
                debris.setAttribute('position', {
                    x: (Math.random()-0.5)*0.2, 
                    y: (Math.random()-0.5)*0.2, 
                    z: 0
                });
                // Animación de explosión
                debris.setAttribute('animation', `property: position; to: ${(Math.random()-0.5)} ${(Math.random()-0.5)} 1; dur: 500; easing: easeOutQuad`);
                crack.appendChild(debris);
            }
            scene.appendChild(crack);

            // 2. La Víbora
            setTimeout(() => {
                const snake = document.createElement('a-entity');
                // IMPORTANTE: Empezar un poco "atrás" de la posición de spawn
                // para que parezca que sale de la pared
                snake.setAttribute('position', pos); 
                
                // Modelo de la víbora
                const head = document.createElement('a-cone');
                head.setAttribute('color', Math.random() > 0.5 ? 'red' : 'green'); // Coralillo vs Boa
                head.setAttribute('rotation', '-90 0 0');
                head.setAttribute('scale', '0.1 0.2 0.1');
                
                const body = document.createElement('a-cylinder');
                body.setAttribute('color', 'black');
                body.setAttribute('height', 1.5);
                body.setAttribute('radius', 0.04);
                body.setAttribute('rotation', '90 0 0'); // Acostado
                body.setAttribute('position', '0 0 -0.75'); // Cola hacia atrás

                snake.appendChild(head);
                snake.appendChild(body);
                
                // Orientar hacia el jugador
                snake.setAttribute('look-at', '#camera');
                
                // ANIMACIÓN DE ATAQUE
                // Sale de la pared y va hacia el jugador
                snake.setAttribute('animation', `property: position; to: ${lookAtTarget.x} ${lookAtTarget.y} ${lookAtTarget.z}; dur: 1500; easing: easeInCubic`);

                scene.appendChild(snake);

                // Limpieza
                setTimeout(() => { 
                    if(snake.parentNode) snake.parentNode.removeChild(snake);
                    if(crack.parentNode) crack.parentNode.removeChild(crack);
                }, 2000);

            }, 500); // Retraso para ver la grieta primero
        }
      });
    </script>

    <a-scene 
      webxr="optionalFeatures: hit-test, mesh-detection, plane-detection; overlay: true"
      room-occlusion
      snake-spawner>

      <a-entity id="camera" camera position="0 1.6 0" look-controls="magicWindowTrackingEnabled: false"></a-entity>
      
      <a-light type="directional" intensity="0.8" position="-1 2 1"></a-light>
      <a-light type="ambient" intensity="0.5"></a-light>

      </a-scene>
  </body>
</html>
